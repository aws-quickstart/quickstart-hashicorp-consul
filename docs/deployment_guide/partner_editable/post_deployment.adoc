// Include any postdeployment steps here, such as steps necessary to test that the deployment was successful. If there are no postdeployment steps, leave this file empty.

== Postdeployment steps

=== Access Consul using SSH (Secure Shell)
To access the Consul environment, first connect to one of the deployed bastion hosts. Then, use an SSH agent to forward your private key on connection. For more information on SSH agents, see the https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent[Generating a new SSH key and adding it to the ssh-agent].

WARNING: Do not copy your private key to the bastion host.

If you use macOS or Linux, complete the following steps.

[start=1]
. Sign into the https://us-east-1.console.aws.amazon.com/console/home?region=us-east-1#[AWS Management Console]. Then open the Amazon EC2 console.
. Choose *Instances* from the left navigation pane.
. Choose one of the two deployed bastion hosts. Note the *Elastic IP* value for the selected instance. You will enter this in Step 6.

[#ec2panel]
.Elastic IP address for a bastion host instance
[link=images/ec2-panel.png]
image::../docs/deployment_guide/images/ec2-panel.png[Architecture,width=648,height=439]

[start=4]
. Run the following command.
[source, bash]
----
ssh-add ~/.ssh/id_rsa
----

[start=5]
. Enter your passphrase when prompted. If you have no passphrase, press `Enter`.
[source, bash]
----
Enter passphrase (empty for no passphrase): [Hit Enter Again or
Enter passphrase]
Enter same passphrase again: [Hit Enter Again or Enter passphrase]
----


[start=6]
. Run the following command. Substitute the Elastic IP value for your instance for `34.198.50.12`.

[source, bash]
----
ssh â€“A ubuntu@34.198.50.12
----

[start=7]
. Enter `yes` when prompted to continue connecting.

[#ec2ssh]
image::../docs/deployment_guide/images/ec2-ssh-1.png[Architecture,width=648,height=439]

[start=8]
. In the Amazon EC2 console, select one of the Consul-Server or Consul-Client hosts and note its private IP address.

[#ec2consulip]
.Finding the private IP address for Consul-Server
[link=images/ec2-consul-ip.png]
image::../docs/deployment_guide/images/ec2-consul-ip.png[Architecture,width=648,height=439]

In the example in Figure 2, the private IP for Consul-Server is *172.31.35.7*.

[start=9]
. From the bastion host, connect to the Consul-Server or Consul-Client host, using Ubuntu as the user:

[#ec2ssh2]
image::../docs/deployment_guide/images/ec2-ssh-2.png[Architecture,width=648,height=439]

[start=10]
. View Consul members:
[source, bash]
----
consul members
----

[#ec2ssh3]
image::../docs/deployment_guide/images/ec2-ssh-3.png[Architecture,width=648,height=439]

=== Test the deployment
To access the Consul server cluster environment, access the Elastic Load Balancing (ELB)
endpoint that was created during the deployment.

[start=1]
. Locate the ELB endpoint address from the Outputs tab of the AWS CloudFormation console.

[#elb]
image::../docs/deployment_guide/images/elb.png[Architecture,width=648,height=439]

[start=2]
. Use your preferred web browser to open the URL. You will see the Consul server cluster dashboard.

[#consul-ui]
.Consul web UI
[link=images/consul-ui.png]
image::../docs/deployment_guide/images/consul-ui.png[Architecture,width=648,height=439]

=== Get started with Consul
To integrate Consul with your environment and get started with Consul services, see the https://www.consul.io/intro/getting-started/services.html[Getting Started] section of the HashiCorp Consul website.

https://www.consul.io/docs/connect/index.html[Consul Connect] and Autopilot are enabled by default.

[start=1]
. How to set up a service with Consul Connect - service mesh
Consul Connect is enabled by default. To set up a service on the Consul client nodes, you
will need to register the service and proxy with Consul. For more information, please visit
the following HashiCorp Learn pages:

* https://learn.hashicorp.com/consul/getting-started/connect#register-the-service-and-proxy-with-consul[Register the Service and Proxy with Consul]
* https://learn.hashicorp.com/consul/getting-started/connect#register-a-dependent-service-and-proxy[Register a Dependent Service and Proxy]
* https://learn.hashicorp.com/consul/getting-started/connect#control-communication-with-intentions[Control Communication with Intentions]

[start=2]
. How to manage Consul Autopilot
https://www.consul.io/docs/commands/operator/autopilot.html[Consul Autopilot] is enabled by default with the following settings:

[source, bash]
----
"autopilot": {
 "cleanup_dead_servers": true,
 "last_contact_threshold": "200ms",
 "max_trailing_logs": 250,
 "server_stabilization_time": "10s",
 "redundancy_zone_tag": "az",
 "disable_upgrade_migration": false,
 "upgrade_version_tag": ""
}
----

// == Post deployment steps
// If Post-deployment steps are required, add them here. If not, remove the heading

// == Best practices for using {partner-product-name} on AWS
// Provide post-deployment best practices for using the technology on AWS, including considerations such as migrating data, backups, ensuring high performance, high availability, etc. Link to software documentation for detailed information.

// _Add any best practices for using the software._

// == Security
// Provide post-deployment best practices for using the technology on AWS, including considerations such as migrating data, backups, ensuring high performance, high availability, etc. Link to software documentation for detailed information.

// _Add any security-related information._

